services:

  # ============================================
  # REVERSE PROXY
  # ============================================
  caddy:
    image: caddy:latest
    container_name: netbird-caddy
    restart: unless-stopped
    networks: [netbird]
    ports:
      - '80:80'
      - '443:443'
      - '443:443/udp' # HTTP/3 Support
    volumes:
      - netbird_caddy_data:/data
      - ./config/Caddyfile:/etc/caddy/Caddyfile
      # Log volume for CrowdSec
      - ./logs/caddy:/var/log/caddy
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  # ============================================
  # NETBIRD CORE SERVICES
  # ============================================
  dashboard:
    image: netbirdio/dashboard:latest
    container_name: netbird-dashboard
    restart: unless-stopped
    networks: [netbird]
    env_file: .env # Maps to dashboard.env in your setup
    logging:
      driver: "json-file"
      options: {max-size: "50m", max-file: "2"}

  signal:
    image: netbirdio/signal:latest
    container_name: netbird-signal
    restart: unless-stopped
    networks: [netbird]
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  relay:
    image: netbirdio/relay:latest
    container_name: netbird-relay
    restart: unless-stopped
    networks: [netbird]
    env_file: .env # Maps to relay.env
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  management:
    image: netbirdio/management:latest
    container_name: netbird-management
    restart: unless-stopped
    networks: [netbird]
    volumes:
      - netbird_management:/var/lib/netbird
      - ./config/management.json:/etc/netbird/management.json
      # Log volume for CrowdSec parsing
      - ./logs/management:/var/log/netbird
    command: [
      "--port", "80",
      "--log-file", "console",
      "--log-level", "info",
      "--disable-anonymous-metrics=false",
      "--single-account-mode-domain=${DOMAIN}",
      "--dns-domain=${DOMAIN}",
      "--idp-sign-key-refresh-enabled"
    ]
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  # ============================================
  # COTURN (STUN/TURN) - Hardened Configuration
  # ============================================
  coturn:
    image: coturn/coturn:latest
    container_name: netbird-coturn
    restart: unless-stopped
    networks: [netbird]
    # SECURITY FIX: Replaces 'network_mode: host' with specific bindings
    ports:
      - '${PUBLIC_IP}:3478:3478/udp'
      - '${PUBLIC_IP}:3478:3478/tcp'
      - '${PUBLIC_IP}:5349:5349/tcp'
      - '${PUBLIC_IP}:49152-65535:49152-65535/udp'
    volumes:
      - ./config/turnserver.conf:/etc/turnserver.conf:ro
      # Log volume for CrowdSec
      - ./logs/coturn:/var/log/coturn
    command: ["-c", "/etc/turnserver.conf"]
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  # ============================================
  # IDENTITY PROVIDER (ZITADEL)
  # ============================================
  zitadel:
    image: 'ghcr.io/zitadel/zitadel:v2.64' # Pinned minor version
    container_name: netbird-zitadel
    restart: always
    networks: [netbird]
    command: 'start-from-init --masterkeyFromEnv --tlsMode external'
    env_file: .env # Maps to zitadel.env
    depends_on:
      zdb: {condition: service_healthy}
    volumes:
      - ./data/zitadel/machinekey:/machinekey
      - netbird_zitadel_certs:/zdb-certs:ro
      - ./logs/zitadel:/var/log/zitadel
    logging:
      driver: "json-file"
      options: {max-size: "100m", max-file: "2"}

  zdb:
    image: 'postgres:16-alpine'
    container_name: netbird-postgres
    restart: always
    networks: [netbird]
    env_file: .env # Maps to zdb.env
    volumes:
      - netbird_zdb_data:/var/lib/postgresql/data:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "db_prod"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options: {max-size: "50m", max-file: "2"}

  # ============================================
  # SECURITY & MONITORING (CrowdSec)
  # ============================================
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: netbird-crowdsec
    restart: unless-stopped
    networks: [netbird]
    environment:
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/caddy crowdsecurity/postgresql
      - ENROLL_TAGS=netbird,infrastructure
    volumes:
      - ./data/crowdsec:/var/lib/crowdsec/data
      - ./config/crowdsec:/etc/crowdsec
      # Custom Configs
      - ./config/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - ./config/crowdsec/parsers:/etc/crowdsec/parsers/s01-parse:ro
      - ./config/crowdsec/scenarios:/etc/crowdsec/scenarios:ro
      # Logs (Read-Only)
      - ./logs/caddy:/var/log/caddy:ro
      - ./logs/management:/var/log/netbird:ro
      - ./logs/coturn:/var/log/coturn:ro
      - ./logs/zitadel:/var/log/zitadel:ro
      - /var/log/auth.log:/var/log/auth.log:ro
    ports:
      - "127.0.0.1:8080:8080" # LAPI for Bouncer
    logging:
      driver: "json-file"
      options: {max-size: "50m", max-file: "2"}

  cs-firewall-bouncer:
    image: crowdsecurity/cs-firewall-bouncer:latest
    container_name: netbird-bouncer
    restart: unless-stopped
    network_mode: host # Required for iptables access
    environment:
      - CROWDSEC_LAPI_URL=http://127.0.0.1:8080
      - CROWDSEC_LAPI_KEY=${CROWDSEC_BOUNCER_KEY}
      - IPTABLES_CHAINS=INPUT,DOCKER-USER
    depends_on:
      - crowdsec
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    logging:
      driver: "json-file"
      options: {max-size: "50m", max-file: "2"}

volumes:
  netbird_management:
  netbird_caddy_data:
  netbird_zdb_data:
  netbird_zitadel_certs:

networks:
  netbird:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
